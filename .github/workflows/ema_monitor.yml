# GitHub Actions Workflow: EMA eSubmission Monitor
# Purpose: This workflow automates the execution of our ema_scout.py script.
#
# How it works:
# 1. Triggers automatically on a set schedule (daily at 08:00 UTC).
# 2. Can also be triggered manually from the GitHub Actions tab.
# 3. Sets up a clean environment with Python.
# 4. Runs our scout script to check the EMA website for changes.
# 5. If the script updates the 'document_log.json' file, this workflow
#    automatically commits the new log file back to the repository.

name: EMA eSubmission Monitor

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

  # Runs on a schedule (uses UTC time)
  # This is set to run at 8:00 AM UTC every day.
  schedule:
    - cron: '0 8 * * *'

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  run-scout:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Step 1: Checks out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Check out repository code
        uses: actions/checkout@v4

      # Step 2: Sets up a Python environment for use in actions
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Step 3: Installs the Python libraries required by our script
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      # Step 4: Run the actual scout script
      - name: Run the EMA Scout script
        run: python ema_scout.py

      # Step 5: Check for changes in the log file and commit them
      - name: Commit and push if log file changed
        run: |
          # Configure git with a bot user
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions-bot@users.noreply.github.com"
          
          # Add the log file to the staging area
          git add document_log.json
          
          # Commit the file only if there are changes.
          # The 'git diff-index --quiet' command will exit with an error code (1)
          # if there are changes, allowing the commit to proceed.
          # If there are no changes, it exits cleanly (0) and the commit is skipped.
          git diff-index --quiet HEAD || git commit -m "Update EMA document log"
          
          # Push the changes back to the repository
          git push
