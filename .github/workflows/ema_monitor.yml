# GitHub Actions Workflow: EMA eSubmission Monitor
# Purpose: This workflow automates the execution of our ema_scout.py script.
#
# How it works:
# 1. Triggers automatically on a set schedule (daily at 08:00 UTC).
# 2. Can also be triggered manually from the GitHub Actions tab.
# 3. Sets up a clean environment with Python.
# 4. Runs our scout script to check the EMA website for changes.
# 5. If the script updates the 'document_log.json' file, this workflow
#    automatically commits the new log file back to the repository.

name: EMA eSubmission Monitor

# Controls when the workflow will run
on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  run-scout:
    runs-on: ubuntu-latest

    # Grant the workflow permission to write to the repository's contents.
    # This is required for the step that commits the log file back.
    permissions:
      contents: write

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Step 1: Checks out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Check out repository code
        uses: actions/checkout@v4

      # Step 2: Sets up a Python environment for use in actions
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Step 3: Installs the Python libraries required by our script
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      # --- DEBUGGING STEP ---
      # List all files recursively to find where ema_scout.py is located.
      - name: List files in the repository
        run: ls -R

      # Step 4: Run the actual scout script
      # --- FIX ---
      # This step now dynamically finds the script's location instead of using a
      # hardcoded path. This is much more robust.
      - name: Run the EMA Scout script
        run: |
          # Find the script in the repository to handle any subdirectory structure
          SCRIPT_PATH=$(find . -name "ema_scout.py" -print -quit)
          if [ -z "$SCRIPT_PATH" ]; then
            echo "Error: ema_scout.py not found in the repository!"
            exit 1
          fi
          echo "Found script at: $SCRIPT_PATH"
          python "$SCRIPT_PATH"

      # Step 5: Check for changes in the log file and commit them
      - name: Commit and push if log file changed
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions-bot@users.noreply.github.com"
          # The scout script will create the log file in the root, so this path is correct.
          git add document_log.json
          git diff-index --quiet HEAD || git commit -m "Update EMA document log"
          git push
